import React, { useRef, useState, useEffect, useCallback } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

// Use a simple local implementation since we can't directly import from src
// This avoids circular dependencies and path issues
const getMapboxToken = (): string => {
  // Use standard environment variable 
  const token = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
  
  // Fallback token for development
  const fallbackToken = 'pk.eyJ1IjoibG9hZHVwLW1hcCIsImEiOiJjbG5lY2w1NTMwbDR5MnFydGN0bWUxMzk2In0.d7H3g9oFB25EEfMcqKQRsA';
  
  // Return the token or fallback
  return token || fallbackToken;
};

// Mapbox access token - we'll validate this before map initialization
const MAPBOX_ACCESS_TOKEN = getMapboxToken();


// Define Map region type
export interface MapRegion {
  latitude: number;
  longitude: number;
  latitudeDelta: number;
  longitudeDelta: number;
}

// Define MapStyle options
export type MapStyle = 
  | 'streets-v12'  // Default street map
  | 'light-v11'    // Light theme for logistics views
  | 'dark-v11'     // Dark theme
  | 'satellite-v9' // Satellite imagery
  | 'satellite-streets-v12' // Satellite with street overlay
  | 'navigation-day-v1'     // Navigation optimized for day
  | 'navigation-night-v1';  // Navigation optimized for night

export interface MapboxMapProps {
  // Initial center position
  initialCenter?: {
    latitude: number;
    longitude: number;
  };
  // Initial zoom level (0-22)
  initialZoom?: number;
  // Map style
  mapStyle?: MapStyle;
  // Map container style
  style?: React.CSSProperties;
  // Container className
  className?: string;
  // Whether to show user location
  showUserLocation?: boolean;
  // Whether to show navigation controls
  showNavigation?: boolean;
  // Whether to show fullscreen control
  showFullscreen?: boolean;
  // Whether to show scale
  showScale?: boolean;
  // Optional callbacks
  onMapLoad?: (map: mapboxgl.Map) => void;
  onMapMove?: (center: { latitude: number; longitude: number }) => void;
  onMapClick?: (e: mapboxgl.MapMouseEvent) => void;
  onError?: (error: Error) => void;
}

// Memoized component to prevent unnecessary re-renders
const MapboxMap: React.FC<MapboxMapProps> = React.memo(({
  initialCenter = { latitude: 3.1390, longitude: 101.6869 }, // Default: Kuala Lumpur
  initialZoom = 12,
  mapStyle = 'streets-v12',
  style = { width: '100%', height: '400px' },
  className = '',
  showUserLocation = false,
  showNavigation = true,
  showFullscreen = false,
  showScale = true,
  onMapLoad,
  onMapMove,
  onMapClick,
  onError,
}) => {
  // Refs for the map container element
  const mapContainer = useRef<HTMLDivElement>(null);
  // Ref for the map instance
  const map = useRef<mapboxgl.Map | null>(null);
  // State for tracking if the map has loaded
  const [mapLoaded, setMapLoaded] = useState<boolean>(false);
  // State for tracking errors
  const [error, setError] = useState<Error | null>(null);
  // Ref to track if token has been checked (to prevent checking on every render)
  const tokenCheckedRef = useRef<boolean>(false);
  // Ref to track if we're initializing the map (to prevent multiple initialization attempts)
  const initializingRef = useRef<boolean>(false);

  // Check if Mapbox token is available only once on initial render
  useEffect(() => {
    // Skip if we've already checked the token
    if (tokenCheckedRef.current) return;
    
    // Mark as checked so this only runs once
    tokenCheckedRef.current = true;
    
    // CRITICAL FIX: This check should never fail now, but we'll keep it for safety
    if (!MAPBOX_ACCESS_TOKEN) {
      const tokenError = new Error('Mapbox access token is not defined. Please add NEXT_PUBLIC_MAPBOX_TOKEN to your environment variables.');
      console.error(tokenError.message + ' Checked NEXT_PUBLIC_MAPBOX_TOKEN, NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN, and NEXT_PUBLIC_MAPBOX_PUBLIC_TOKEN');
      setError(tokenError);
      if (onError) {
        onError(tokenError);
      }
    } else {
      console.log('Using Mapbox token: ' + MAPBOX_ACCESS_TOKEN.substring(0, 10) + '...');
    }
  }, []); // Empty dependency array ensures this only runs once

  // Initialize map - highly stable memoized function with explicit dependencies
  const initializeMap = useCallback(() => {
    // Skip if we're already initializing, map exists, container is missing, or there's an error
    if (initializingRef.current || map.current || !mapContainer.current || error) return;

    // Also skip if token is missing
    const token = MAPBOX_ACCESS_TOKEN;
    if (!token) return;
    
    // Mark as initializing to prevent multiple initialization attempts
    initializingRef.current = true;

    try {
      console.log('Initializing Mapbox map');
      
      // Set the access token
      mapboxgl.accessToken = token;

      // Create a new map instance
      const newMap = new mapboxgl.Map({
        container: mapContainer.current,
        style: `mapbox://styles/mapbox/${mapStyle}`,
        center: [initialCenter.longitude, initialCenter.latitude],
        zoom: initialZoom,
        attributionControl: true,
      });

      // Add navigation control if enabled
      if (showNavigation) {
        newMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
      }

      // Add fullscreen control if enabled
      if (showFullscreen) {
        newMap.addControl(new mapboxgl.FullscreenControl(), 'top-right');
      }

      // Add scale control if enabled
      if (showScale) {
        newMap.addControl(new mapboxgl.ScaleControl(), 'bottom-left');
      }

      // Add geolocate control if user location is enabled
      if (showUserLocation) {
        newMap.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: {
              enableHighAccuracy: true,
            },
            trackUserLocation: true,
            showUserHeading: true,
          }),
          'top-right'
        );
      }

      // Set up event handlers
      newMap.on('load', () => {
        console.log('Mapbox map loaded');
        setMapLoaded(true);
        if (onMapLoad) onMapLoad(newMap);
        initializingRef.current = false; // Reset initializing flag
      });

      newMap.on('move', () => {
        const center = newMap.getCenter();
        if (onMapMove) {
          onMapMove({
            latitude: center.lat,
            longitude: center.lng,
          });
        }
      });

      newMap.on('click', (e) => {
        if (onMapClick) onMapClick(e);
      });

      newMap.on('error', (e) => {
        initializingRef.current = false; // Reset initializing flag on error
        const mapError = new Error(`Mapbox error: ${e.error ? e.error.message : 'Unknown error'}`);
        console.error('Mapbox error:', e);
        setError(mapError);
        if (onError) onError(mapError);
      });

      // Store the map instance in the ref
      map.current = newMap;
    } catch (initError) {
      initializingRef.current = false; // Reset initializing flag on error
      const mapInitError = initError instanceof Error 
        ? initError 
        : new Error('Failed to initialize Mapbox map');
      
      console.error('Map initialization error:', mapInitError);
      setError(mapInitError);
      if (onError) onError(mapInitError);
    }
  }, [
    initialCenter.latitude,
    initialCenter.longitude,
    initialZoom,
    mapStyle,
    showUserLocation,
    showNavigation,
    showFullscreen,
    showScale,
    onMapLoad,
    onMapMove,
    onMapClick,
    onError,
    error,
  ]);

  // Initialize map effect with proper dependencies
  useEffect(() => {
    // Only run initialization if we have a token and if map isn't already initialized
    if (MAPBOX_ACCESS_TOKEN && !map.current && !error && !initializingRef.current) {
      // Add small timeout to ensure DOM is ready
      const timeoutId = setTimeout(() => {
        initializeMap();
      }, 0);
      
      return () => clearTimeout(timeoutId);
    }
    
    // Cleanup only - no initialization
    return () => {
      if (map.current) {
        map.current.remove();
        map.current = null;
        setMapLoaded(false);
      }
    };
  }, [initializeMap, error]);

  // Handle map resize on window resize
  useEffect(() => {
    const handleResize = () => {
      if (map.current) {
        map.current.resize();
      }
    };

    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  // Render the map container - memoized for stability
  return (
    <div className={`mapbox-container ${className}`} style={style}>
      {error ? (
        <div className="map-error-container p-4 bg-red-50 text-red-700 rounded">
          <p className="map-error-message">
            Failed to load map: {error.message}
          </p>
        </div>
      ) : (
        <div ref={mapContainer} style={{ width: '100%', height: '100%' }} />
      )}
    </div>
  );
});

// Set display name for debugging
MapboxMap.displayName = 'MapboxMap';

export default MapboxMap; 